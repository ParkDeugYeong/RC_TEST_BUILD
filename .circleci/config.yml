version: 2.1

orbs:
  node: circleci/node@5.1.0

workflows:
  build-and-test:
    jobs:
      - lint-and-test
      - build-expo:
          requires:
            - lint-and-test
      - build-apk:
          requires:
            - build-expo
          filters:
            branches:
              only:
                - main

jobs:
  lint-and-test:
    docker:
      - image: cimg/node:18.20
    steps:
      - checkout
      
      # Yarn 4.9.1 ÏÑ§Ï†ï (Corepack ÏÇ¨Ïö©)
      - run:
          name: Setup Yarn 4.9.1
          command: |
            mkdir -p ~/.corepack
            corepack enable --install-directory ~/.corepack
            echo 'export PATH="$HOME/.corepack:$PATH"' >> $BASH_ENV
            source $BASH_ENV
            corepack prepare yarn@4.9.1 --activate
            yarn --version
            yarn config set nodeLinker node-modules
      
      # ÏùòÏ°¥ÏÑ± ÏÑ§Ïπò
      - run:
          name: Install Dependencies
          command: |
            yarn install --immutable
            # node_modules Ï∫êÏãú ÌÅ¥Î¶¨Ïñ¥ (Metro Ìò∏ÌôòÏÑ± Î¨∏Ï†ú Ìï¥Í≤∞)
            rm -rf node_modules/.cache
            # Expo SDK 53Ïù¥ ÏûêÎèôÏúºÎ°ú Metro Î≤ÑÏ†ÑÏùÑ Í¥ÄÎ¶¨ÌïòÎèÑÎ°ù Ìï®
            # Metro Ìå®ÌÇ§ÏßÄÎì§ÏùÑ ÏàòÎèôÏúºÎ°ú ÏÑ§ÏπòÌïòÏßÄ ÏïäÍ≥† ExpoÍ∞Ä Ìò∏ÌôòÎêòÎäî Î≤ÑÏ†ÑÏùÑ ÏÑ†ÌÉùÌïòÎèÑÎ°ù Ìï®
            # Expo CLIÎ•º ÌîÑÎ°úÏ†ùÌä∏ ÏùòÏ°¥ÏÑ±ÏúºÎ°ú ÏÑ§Ïπò
            yarn add -D @expo/cli
          
      # TypeScript ÌÉÄÏûÖ Ï≤¥ÌÅ¨
      - run:
          name: TypeScript Type Check
          command: yarn tsc --noEmit
          
      # ESLint Í≤ÄÏÇ¨
      - run:
          name: Run ESLint
          command: yarn lint
          
      # ÌÖåÏä§Ìä∏ Ïã§Ìñâ (JestÍ∞Ä ÏÑ§Ï†ïÎêòÏñ¥ ÏûàÎã§Î©¥)
      - run:
          name: Run Tests
          command: |
            if [ -f "jest.config.js" ] || grep -q '"test"' package.json; then
              yarn test --watchAll=false
            else
              echo "No tests found, skipping..."
            fi

  build-expo:
    docker:
      - image: cimg/node:18.20
    steps:
      - checkout
      
      # Yarn 4.9.1 ÏÑ§Ï†ï (Corepack ÏÇ¨Ïö©)
      - run:
          name: Setup Yarn 4.9.1
          command: |
            mkdir -p ~/.corepack
            corepack enable --install-directory ~/.corepack
            echo 'export PATH="$HOME/.corepack:$PATH"' >> $BASH_ENV
            source $BASH_ENV
            corepack prepare yarn@4.9.1 --activate
            yarn --version
            yarn config set nodeLinker node-modules
            
      # ÏùòÏ°¥ÏÑ± ÏÑ§Ïπò
      - run:
          name: Install Dependencies
          command: |
            yarn install --immutable
            # node_modules Ï∫êÏãú ÌÅ¥Î¶¨Ïñ¥ (Metro Ìò∏ÌôòÏÑ± Î¨∏Ï†ú Ìï¥Í≤∞)
            rm -rf node_modules/.cache
            # Expo SDK 53Ïù¥ ÏûêÎèôÏúºÎ°ú Metro Î≤ÑÏ†ÑÏùÑ Í¥ÄÎ¶¨ÌïòÎèÑÎ°ù Ìï®
            # Metro Ìå®ÌÇ§ÏßÄÎì§ÏùÑ ÏàòÎèôÏúºÎ°ú ÏÑ§ÏπòÌïòÏßÄ ÏïäÍ≥† ExpoÍ∞Ä Ìò∏ÌôòÎêòÎäî Î≤ÑÏ†ÑÏùÑ ÏÑ†ÌÉùÌïòÎèÑÎ°ù Ìï®
            # Expo CLIÎ•º ÌîÑÎ°úÏ†ùÌä∏ ÏùòÏ°¥ÏÑ±ÏúºÎ°ú ÏÑ§Ïπò
            yarn add -D @expo/cli
          
      # Expo CLI ÏÑ§Ïπò Î∞è Ïù∏Ï¶ù
      - run:
          name: Install Expo CLI
          command: |
            # Yarn BerryÏóêÏÑúÎäî global Î™ÖÎ†πÏñ¥Í∞Ä Ï†úÍ±∞Îê®
            # yarn dlxÎ•º ÏÇ¨Ïö©ÌïòÏó¨ ÏûÑÏãúÎ°ú ÏÑ§ÏπòÌïòÍ≥† Ïã§Ìñâ
            echo "Expo CLIÎäî yarn dlxÎ°ú Ïã§ÌñâÎê©ÎãàÎã§"
          
      - run:
          name: Expo Authentication
          command: |
            # EXPO_TOKEN ÌôòÍ≤ΩÎ≥ÄÏàò ÌôïÏù∏ Î∞è ÏÑ§Ï†ï
            echo "Checking EXPO_TOKEN environment variable..."
            if [ -z "$EXPO_TOKEN" ]; then
              echo "ERROR: EXPO_TOKEN environment variable is not set"
              exit 1
            fi
            
            # Expo ÌôòÍ≤ΩÎ≥ÄÏàò Î™ÖÏãúÏ†Å ÏÑ§Ï†ï
            export EXPO_TOKEN=$EXPO_TOKEN
            echo "EXPO_TOKEN is set (length: ${#EXPO_TOKEN})"
            
            # Ïù∏Ï¶ù ÏÉÅÌÉú ÌôïÏù∏ (ÌîÑÎ°úÏ†ùÌä∏Ïóê ÏÑ§ÏπòÎêú CLI ÏÇ¨Ïö©)
            yarn expo whoami || echo "Authentication failed, but continuing..."
          
      # Expo ÌîÑÎ°úÏ†ùÌä∏ ÎπåÎìú (Î™®Î∞îÏùº Ï†ÑÏö©: Android + iOS)
      - run:
          name: Build Expo Android
          command: |
            export NODE_OPTIONS="--max-old-space-size=4096"
            export EXPO_TOKEN=$EXPO_TOKEN
            yarn expo export --platform android
            
      - run:
          name: Build Expo iOS
          command: |
            export NODE_OPTIONS="--max-old-space-size=4096"
            export EXPO_TOKEN=$EXPO_TOKEN
            yarn expo export --platform ios
            
      # ÎπåÎìú Í≤∞Í≥ºÎ¨º Ï†ÄÏû•
      - store_artifacts:
          path: dist
          destination: expo-mobile-builds
          
      # Ï∫êÏãú Ï†ÄÏû•
      - save_cache:
          key: expo-build-{{ .Branch }}-{{ .Revision }}
          paths:
            - dist

  build-apk:
    docker:
      - image: cimg/node:18.20
    steps:
      - checkout

      # Yarn 4.9.1 ÏÑ§Ï†ï (Corepack ÏÇ¨Ïö©)
      - run:
          name: Setup Yarn 4.9.1
          command: |
            mkdir -p ~/.corepack
            corepack enable --install-directory ~/.corepack
            echo 'export PATH="$HOME/.corepack:$PATH"' >> $BASH_ENV
            source $BASH_ENV
            corepack prepare yarn@4.9.1 --activate
            yarn --version
            yarn config set nodeLinker node-modules

      # ÏùòÏ°¥ÏÑ± ÏÑ§Ïπò
      - run:
          name: Install Dependencies
          command: |
            yarn install --immutable
            # node_modules Ï∫êÏãú ÌÅ¥Î¶¨Ïñ¥ (Metro Ìò∏ÌôòÏÑ± Î¨∏Ï†ú Ìï¥Í≤∞)
            rm -rf node_modules/.cache
            # Expo SDK 53Ïù¥ ÏûêÎèôÏúºÎ°ú Metro Î≤ÑÏ†ÑÏùÑ Í¥ÄÎ¶¨ÌïòÎèÑÎ°ù Ìï®
            # Metro Ìå®ÌÇ§ÏßÄÎì§ÏùÑ ÏàòÎèôÏúºÎ°ú ÏÑ§ÏπòÌïòÏßÄ ÏïäÍ≥† ExpoÍ∞Ä Ìò∏ÌôòÎêòÎäî Î≤ÑÏ†ÑÏùÑ ÏÑ†ÌÉùÌïòÎèÑÎ°ù Ìï®
            # Expo CLIÎ•º ÌîÑÎ°úÏ†ùÌä∏ ÏùòÏ°¥ÏÑ±ÏúºÎ°ú ÏÑ§Ïπò
            yarn add -D @expo/cli

      # EAS CLI ÏÑ§Ïπò
      - run:
          name: Install EAS CLI
          command: yarn add -D eas-cli

      # Expo Ïù∏Ï¶ù (EXPO_TOKEN ÌôòÍ≤ΩÎ≥ÄÏàò ÏÇ¨Ïö©)
      - run:
          name: Expo Authentication
          command: |
            # EXPO_TOKEN ÌôòÍ≤ΩÎ≥ÄÏàò ÌôïÏù∏ Î∞è ÏÑ§Ï†ï
            echo "Checking EXPO_TOKEN environment variable..."
            if [ -z "$EXPO_TOKEN" ]; then
              echo "ERROR: EXPO_TOKEN environment variable is not set"
              exit 1
            fi

            # Expo ÌôòÍ≤ΩÎ≥ÄÏàò Î™ÖÏãúÏ†Å ÏÑ§Ï†ï
            export EXPO_TOKEN=$EXPO_TOKEN
            echo "EXPO_TOKEN is set (length: ${#EXPO_TOKEN})"

            # Ïù∏Ï¶ù ÏÉÅÌÉú ÌôïÏù∏ (ÌîÑÎ°úÏ†ùÌä∏Ïóê ÏÑ§ÏπòÎêú CLI ÏÇ¨Ïö©)
            yarn eas whoami || echo "Authentication check failed, but continuing..."

      # APK ÎπåÎìú Ïã§Ìñâ (Î∞±Í∑∏ÎùºÏö¥Îìú)
      - run:
          name: Start Android APK Build
          command: |
            export NODE_OPTIONS="--max-old-space-size=4096"
            export EXPO_TOKEN=$EXPO_TOKEN
            # ÎπåÎìú ÏãúÏûëÌïòÍ≥† Build ID Ï†ÄÏû• (ÏóÖÎ°úÎìúÎßå ÌïòÍ≥† ÎåÄÍ∏∞ÌïòÏßÄ ÏïäÏùå)
            echo "Starting EAS Build upload and initialization..."
            yarn eas build --platform android --profile apk --non-interactive --no-wait --json > build_result.json
            BUILD_ID=$(cat build_result.json | jq -r '.id')
            echo "Build started with ID: $BUILD_ID"
            echo $BUILD_ID > build_id.txt
            echo "Build upload completed and queued for processing."
            echo "Build will be monitored in the next step..."
          no_output_timeout: 10m

      # ÎπåÎìú ÏôÑÎ£å ÎåÄÍ∏∞ (Ìè¥ÎßÅ Î∞©Ïãù)
      - run:
          name: Wait for Build Completion
          command: |
            export EXPO_TOKEN=$EXPO_TOKEN
            BUILD_ID=$(cat build_id.txt)
            echo "Waiting for build $BUILD_ID to complete..."
            
            # ÏµúÎåÄ 90Î∂Ñ ÎåÄÍ∏∞ (2Î∂ÑÎßàÎã§ Ï≤¥ÌÅ¨) - EAS Î¨¥Î£å Í≥ÑÏ†ï ÌÅê ÎåÄÍ∏∞ÏãúÍ∞Ñ Í≥†Î†§
            for i in {1..45}; do
              echo "===== Build Status Check $i/45 ====="
              STATUS=$(yarn eas build:list --build-id $BUILD_ID --json | jq -r '.[0].status')
              CURRENT_TIME=$(date)
              echo "Current time: $CURRENT_TIME"
              echo "Build ID: $BUILD_ID"
              echo "Build status: $STATUS"
              
              if [ "$STATUS" = "finished" ]; then
                echo "üéâ Build completed successfully!"
                break
              elif [ "$STATUS" = "errored" ] || [ "$STATUS" = "canceled" ]; then
                echo "‚ùå Build failed with status: $STATUS"
                echo "Check logs: https://expo.dev/accounts/parkseohoo/projects/RC_BUILD_TEST/builds/$BUILD_ID"
                exit 1
              elif [ "$STATUS" = "in-queue" ]; then
                echo "‚è≥ Build is waiting in queue..."
              elif [ "$STATUS" = "in-progress" ]; then
                echo "üîÑ Build is in progress..."
              else
                echo "üìã Build status: $STATUS"
              fi
              
              echo "Next check in 2 minutes..."
              echo "========================================="
              
              # 2Î∂Ñ ÎåÄÍ∏∞ (Îçî ÏûêÏ£º Ï≤¥ÌÅ¨ÌïòÏó¨ Ï∂úÎ†• Ïú†ÏßÄ)
              sleep 120
            done
            
            # ÏµúÏ¢Ö ÏÉÅÌÉú ÌôïÏù∏
            FINAL_STATUS=$(yarn eas build:list --build-id $BUILD_ID --json | jq -r '.[0].status')
            if [ "$FINAL_STATUS" != "finished" ]; then
              echo "Build did not complete within 90 minutes. Status: $FINAL_STATUS"
              echo "EAS Build queue may be experiencing delays. Check: https://expo.dev/accounts/parkseohoo/projects/RC_BUILD_TEST/builds"
              exit 1
            fi
          no_output_timeout: 95m

      # ÎπåÎìú Í≤∞Í≥º Îã§Ïö¥Î°úÎìú Î∞è Ï†ÄÏû•
      - run:
          name: Download APK
          command: |
            export EXPO_TOKEN=$EXPO_TOKEN
            BUILD_ID=$(cat build_id.txt)
            
            # ÌäπÏ†ï ÎπåÎìú IDÎ°ú ÎπåÎìú Ï†ïÎ≥¥ Í∞ÄÏ†∏Ïò§Í∏∞
            yarn eas build:list --build-id $BUILD_ID --json > build_info.json
            BUILD_URL=$(cat build_info.json | jq -r '.[0].artifacts.buildUrl')
            
            if [ "$BUILD_URL" != "null" ] && [ "$BUILD_URL" != "" ]; then
              mkdir -p apk-build
              curl -L -o apk-build/app.apk "$BUILD_URL"
              echo "APK downloaded successfully from: $BUILD_URL"
              ls -la apk-build/
            else
              echo "No build URL found for build ID: $BUILD_ID"
              cat build_info.json
              exit 1
            fi

      # APK ÏïÑÌã∞Ìå©Ìä∏ Ï†ÄÏû•
      - store_artifacts:
          path: apk-build
          destination: android-apk

      # Ï∫êÏãú Ï†ÄÏû•
      - save_cache:
          key: eas-build-{{ .Branch }}-{{ .Revision }}
          paths:
            - node_modules