version: 2.1

orbs:
  node: circleci/node@5.1.0

workflows:
  build-and-test:
    jobs:
      - lint-and-test
      - build-apk:
          requires:
            - lint-and-test
          filters:
            branches:
              only:
                - main

jobs:
  lint-and-test:
    docker:
      - image: cimg/node:18.20
    steps:
      - checkout
      
      # ìºì‹œ ë³µì› (node_modules)
      - restore_cache:
          keys:
            - yarn-deps-{{ checksum "yarn.lock" }}
            - yarn-deps-
      
      # Yarn 4.9.1 ì„¤ì • (Corepack ì‚¬ìš©)
      - run:
          name: Setup Yarn 4.9.1
          command: |
            mkdir -p ~/.corepack
            corepack enable --install-directory ~/.corepack
            echo 'export PATH="$HOME/.corepack:$PATH"' >> $BASH_ENV
            source $BASH_ENV
            corepack prepare yarn@4.9.1 --activate
            yarn --version
            yarn config set nodeLinker node-modules
      
      # ì˜ì¡´ì„± ì„¤ì¹˜
      - run:
          name: Install Dependencies
          command: |
            yarn install --immutable
            # node_modules ìºì‹œ í´ë¦¬ì–´ (Metro í˜¸í™˜ì„± ë¬¸ì œ í•´ê²°)
            rm -rf node_modules/.cache
            # Expo SDK 53ì´ ìžë™ìœ¼ë¡œ Metro ë²„ì „ì„ ê´€ë¦¬í•˜ë„ë¡ í•¨
            # Metro íŒ¨í‚¤ì§€ë“¤ì„ ìˆ˜ë™ìœ¼ë¡œ ì„¤ì¹˜í•˜ì§€ ì•Šê³  Expoê°€ í˜¸í™˜ë˜ëŠ” ë²„ì „ì„ ì„ íƒí•˜ë„ë¡ í•¨

      # ìºì‹œ ì €ìž¥ (node_modules)
      - save_cache:
          key: yarn-deps-{{ checksum "yarn.lock" }}
          paths:
            - node_modules
          
      # TypeScript íƒ€ìž… ì²´í¬
      - run:
          name: TypeScript Type Check
          command: yarn tsc --noEmit
          
      # ESLint ê²€ì‚¬
      - run:
          name: Run ESLint
          command: yarn lint
          
      # í…ŒìŠ¤íŠ¸ ì‹¤í–‰ (Jestê°€ ì„¤ì •ë˜ì–´ ìžˆë‹¤ë©´)
      - run:
          name: Run Tests
          command: |
            if [ -f "jest.config.js" ] || grep -q '"test"' package.json; then
              yarn test --watchAll=false
            else
              echo "No tests found, skipping..."
            fi

  build-apk:
    docker:
      - image: cimg/node:18.20
    steps:
      - checkout

      # ìºì‹œ ë³µì› (node_modules)
      - restore_cache:
          keys:
            - yarn-deps-{{ checksum "yarn.lock" }}
            - yarn-deps-

      # Yarn 4.9.1 ì„¤ì • (Corepack ì‚¬ìš©)
      - run:
          name: Setup Yarn 4.9.1
          command: |
            mkdir -p ~/.corepack
            corepack enable --install-directory ~/.corepack
            echo 'export PATH="$HOME/.corepack:$PATH"' >> $BASH_ENV
            source $BASH_ENV
            corepack prepare yarn@4.9.1 --activate
            yarn --version
            yarn config set nodeLinker node-modules

      # ì˜ì¡´ì„± ì„¤ì¹˜
      - run:
          name: Install Dependencies
          command: |
            yarn install --immutable
            # node_modules ìºì‹œ í´ë¦¬ì–´ (Metro í˜¸í™˜ì„± ë¬¸ì œ í•´ê²°)
            rm -rf node_modules/.cache
            # Expo SDK 53ì´ ìžë™ìœ¼ë¡œ Metro ë²„ì „ì„ ê´€ë¦¬í•˜ë„ë¡ í•¨
            # Metro íŒ¨í‚¤ì§€ë“¤ì„ ìˆ˜ë™ìœ¼ë¡œ ì„¤ì¹˜í•˜ì§€ ì•Šê³  Expoê°€ í˜¸í™˜ë˜ëŠ” ë²„ì „ì„ ì„ íƒí•˜ë„ë¡ í•¨

      # ìºì‹œ ì €ìž¥ (node_modules)
      - save_cache:
          key: yarn-deps-{{ checksum "yarn.lock" }}
          paths:
            - node_modules

      # ìœ í‹¸ë¦¬í‹° ì„¤ì¹˜ (jq ë“±)
      - run:
          name: Install utilities (jq)
          command: |
            sudo apt-get update
            sudo apt-get install -y jq

      # Expo ì¸ì¦ (EXPO_TOKEN í™˜ê²½ë³€ìˆ˜ ì‚¬ìš©)
      - run:
          name: Expo Authentication
          command: |
            # EXPO_TOKEN í™˜ê²½ë³€ìˆ˜ í™•ì¸ ë° ì„¤ì •
            echo "Checking EXPO_TOKEN environment variable..."
            if [ -z "$EXPO_TOKEN" ]; then
              echo "ERROR: EXPO_TOKEN environment variable is not set"
              exit 1
            fi

            # Expo í™˜ê²½ë³€ìˆ˜ ëª…ì‹œì  ì„¤ì •
            export EXPO_TOKEN=$EXPO_TOKEN
            echo "EXPO_TOKEN is set (length: ${#EXPO_TOKEN})"

            # ì¸ì¦ ìƒíƒœ í™•ì¸ (í”„ë¡œì íŠ¸ì— ì„¤ì¹˜ëœ CLI ì‚¬ìš©)
            yarn eas whoami --non-interactive || echo "Authentication check failed, but continuing..."

      # APK ë¹Œë“œ ì‹¤í–‰ (ë°±ê·¸ë¼ìš´ë“œ)
      - run:
          name: Start Android APK Build
          command: |
            export NODE_OPTIONS="--max-old-space-size=4096"
            export EXPO_TOKEN=$EXPO_TOKEN
            # ë¹Œë“œ ì‹œìž‘í•˜ê³  Build ID ì €ìž¥ (ì—…ë¡œë“œë§Œ í•˜ê³  ëŒ€ê¸°í•˜ì§€ ì•ŠìŒ)
            echo "Starting EAS Build upload and initialization..."
            yarn eas build --platform android --profile apk --non-interactive --no-wait --json > build_result.json
            
            # JSON íŒŒì‹± ì•ˆì „í•˜ê²Œ ì²˜ë¦¬
            cat build_result.json
            echo "=== Parsing Build ID ==="
            
            # ë°°ì—´ì¸ì§€ ê°ì²´ì¸ì§€ í™•ì¸í•˜ê³  ì ì ˆížˆ íŒŒì‹±
            if cat build_result.json | jq -e 'type == "array"' > /dev/null; then
              BUILD_ID=$(cat build_result.json | jq -r '.[0].id // .id // "unknown"')
            else
              BUILD_ID=$(cat build_result.json | jq -r '.id // "unknown"')
            fi
            
            echo "Build started with ID: $BUILD_ID"
            echo $BUILD_ID > build_id.txt
            echo "Build upload completed and queued for processing."
            echo "Build will be monitored in the next step..."
          no_output_timeout: 10m

      # ë¹Œë“œ ì™„ë£Œ ëŒ€ê¸° (í´ë§ ë°©ì‹)
      - run:
          name: Wait for Build Completion
          command: |
            export EXPO_TOKEN=$EXPO_TOKEN
            BUILD_ID=$(cat build_id.txt)
            echo "Waiting for build $BUILD_ID to complete..."
            
            # ìµœëŒ€ 90ë¶„ ëŒ€ê¸° (2ë¶„ë§ˆë‹¤ ì²´í¬) - EAS ë¬´ë£Œ ê³„ì • í ëŒ€ê¸°ì‹œê°„ ê³ ë ¤
            for i in {1..45}; do
              echo "===== Build Status Check $i/45 ====="
              
              # Build ID ìœ íš¨ì„± ê²€ì‚¬
              if [ "$BUILD_ID" = "unknown" ] || [ -z "$BUILD_ID" ]; then
                echo "âŒ Invalid Build ID: $BUILD_ID"
                echo "Check the EAS build logs manually"
                exit 1
              fi
              
              # ë¹Œë“œ ìƒíƒœ ì¡°íšŒ (ì•ˆì „í•œ íŒŒì‹±)
              echo "Checking build status for ID: $BUILD_ID"
              if ! yarn eas build:list --non-interactive --json > status_result.json; then
                echo "build:list failed, trying alternative"
                yarn eas build:view $BUILD_ID --non-interactive --json > status_result.json || echo "build:view also failed"
              fi
              
              cat status_result.json
              
              # JSONì—ì„œ ìƒíƒœ ì¶”ì¶œ (ì—¬ëŸ¬ í˜•ì‹ ì§€ì›)
              if cat status_result.json | jq -e 'type == "array"' > /dev/null 2>&1; then
                STATUS=$(cat status_result.json | jq -r '.[] | select(.id == "'$BUILD_ID'") | .status // "unknown"')
              else
                STATUS=$(cat status_result.json | jq -r '.status // "unknown"')
              fi
              
              CURRENT_TIME=$(date)
              echo "Current time: $CURRENT_TIME"
              echo "Build ID: $BUILD_ID"
              echo "Build status: $STATUS"
              
              if [ "$STATUS" = "finished" ]; then
                echo "ðŸŽ‰ Build completed successfully!"
                break
              elif [ "$STATUS" = "errored" ] || [ "$STATUS" = "canceled" ]; then
                echo "âŒ Build failed with status: $STATUS"
                echo "Check logs: https://expo.dev/accounts/parkseohoo/projects/RC_BUILD_TEST/builds/$BUILD_ID"
                exit 1
              elif [ "$STATUS" = "in-queue" ]; then
                echo "â³ Build is waiting in queue..."
              elif [ "$STATUS" = "in-progress" ]; then
                echo "ðŸ”„ Build is in progress..."
              else
                echo "ðŸ“‹ Build status: $STATUS"
              fi
              
              echo "Next check in 2 minutes..."
              echo "========================================="
              
              # 2ë¶„ ëŒ€ê¸° (ë” ìžì£¼ ì²´í¬í•˜ì—¬ ì¶œë ¥ ìœ ì§€)
              sleep 120
            done
            
            # ìµœì¢… ìƒíƒœ í™•ì¸
            echo "Final build status check..."
            yarn eas build:view $BUILD_ID --non-interactive --json > final_status.json || yarn eas build:list --non-interactive --json > final_status.json
            if cat final_status.json | jq -e 'type == "array"' > /dev/null 2>&1; then
              FINAL_STATUS=$(cat final_status.json | jq -r '.[] | select(.id == '"'$BUILD_ID'"') | .status // "unknown"')
            else
              FINAL_STATUS=$(cat final_status.json | jq -r '.status // "unknown"')
            fi
            if [ "$FINAL_STATUS" != "finished" ]; then
              echo "Build did not complete within 90 minutes. Status: $FINAL_STATUS"
              echo "EAS Build queue may be experiencing delays. Check: https://expo.dev/accounts/parkseohoo/projects/RC_BUILD_TEST/builds"
              exit 1
            fi
          no_output_timeout: 95m

      # ë¹Œë“œ ê²°ê³¼ ë‹¤ìš´ë¡œë“œ ë° ì €ìž¥
      - run:
          name: Download APK
          command: |
            export EXPO_TOKEN=$EXPO_TOKEN
            BUILD_ID=$(cat build_id.txt)
            
            # íŠ¹ì • ë¹Œë“œ IDë¡œ ë¹Œë“œ ì •ë³´ ê°€ì ¸ì˜¤ê¸° (build:view ì‚¬ìš©)
            yarn eas build:view $BUILD_ID --non-interactive --json > build_info.json
            if cat build_info.json | jq -e 'type == "array"' > /dev/null 2>&1; then
              BUILD_URL=$(cat build_info.json | jq -r '.[0].artifacts.buildUrl // empty')
            else
              BUILD_URL=$(cat build_info.json | jq -r '.artifacts.buildUrl // empty')
            fi
            
            if [ -n "$BUILD_URL" ]; then
              mkdir -p apk-build
              curl -L -o apk-build/app.apk "$BUILD_URL"
              echo "APK downloaded successfully from: $BUILD_URL"
              ls -la apk-build/
            else
              echo "No build URL found for build ID: $BUILD_ID"
              cat build_info.json
              exit 1
            fi

      # APK ì•„í‹°íŒ©íŠ¸ ì €ìž¥
      - store_artifacts:
          path: apk-build
          destination: android-apk